<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title> Ø·Ø¨ÙŠØ¨ÙŠ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠ</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

    /* CSS Variables Ù„Ù„Ù€Themes (Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙÙŠ xray.html) */
    :root {
      /* Light Mode (Ø§ÙØªØ±Ø§Ø¶ÙŠ) */
      --bg-color: #f4f7fb;
      --card-bg: #ffffff;
      --text-color: #333;
      --secondary-text: #444;
      --border-color: #bbb;
      --primary-blue: #1e88e5;
      --button-bg: #2b5f87;
      --button-hover: #3f88c5;
      --upload-bg: #f9fcff;
      --upload-border: #b3cce6;
      --upload-hover-bg: #eef6ff;
      --upload-hover-border: #3f88c5;
      --shadow-light: rgba(0,0,0,.06);
      --shadow-medium: rgba(0,0,0,.05);
      --shadow-heavy: rgba(0,0,0,.05);
      --icon-color: #1e88e5; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
      --conf-high: #16a34a; /* Ø£Ø¶ÙØª Ù„Ù„ØªØ´Ø®ÙŠØµØ§Øª ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚ */
      --conf-moderate: #f97316;
      --conf-low: #dc2626;
      --animated-text-color: #60a5fa; /* Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© ÙƒÙ…Ø§ ÙÙŠ xray */
      --secondary-button-bg: #f1f1f1;
      --secondary-button-hover: #ddd;
    }
  [data-theme="dark"] header,
[data-theme="dark"] footer {
  background: #0d47a1 !important;
}

    [data-theme="dark"] {
      
      /* Dark Mode */
      --bg-color: #1a1a1a;
      --card-bg: #2c2c2c;
      --text-color: #f5f5f5;
      --secondary-text: #b8b8b8;
      --border-color: #555;
      --primary-blue: #64b5f6;
      --button-bg: #37474f;
      --button-hover: #546e7a;
      --upload-bg: #2d3748;
      --upload-border: #4a5568;
      --upload-hover-bg: #4a5568;
      --upload-hover-border: #63b3ed;
      --shadow-light: rgba(0,0,0,.3);
      --shadow-medium: rgba(0,0,0,.4);
      --shadow-heavy: rgba(0,0,0,.2);
      --icon-color: #64b5f6; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø¯Ø§Ø±Ùƒ */
      --conf-high: #16a34a;
      --conf-moderate: #f97316;
      --conf-low: #dc2626;
      --animated-text-color: #a5b4fc; /* Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¯Ø§Ø±Ùƒ */
      --secondary-button-bg: #2a2a2a;
      --secondary-button-hover: #3a3a3a;
    }
  /* Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ ÙÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
* {
    -webkit-user-select: none;  /* Safari */
    -moz-user-select: none;     /* Firefox */
    -ms-user-select: none;      /* Internet Explorer/Edge */
    user-select: none;          /* Non-prefixed version */
}

/* Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ù†ØµÙˆØµ Ø­ØªÙ‰ ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© */
input, textarea, [contenteditable="true"] {
    -webkit-user-select: text;  /* Safari */
    -moz-user-select: text;     /* Firefox */
    -ms-user-select: text;      /* Internet Explorer/Edge */
    user-select: text;          /* Non-prefixed version */
}

    body {
  font-family: 'Tajawal', sans-serif;
  background: var(--bg-color);
  margin: 0;
  color: var(--text-color);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  transition: background 0.3s ease, color 0.3s ease;
}
  h1 {
      margin: 0 0 10px;
      font-size: 20px;
      color: var(--primary-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    h1 i {
      font-size: 1.5rem;
      color: var(--icon-color);
    }
  .wrap {
      max-width: 980px;
      padding: 16px;
      margin: 0 auto;
      padding: 10px;
    }

    a { text-decoration: none; }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù…Ø¯Ù…Ø¬ Ù…Ù† dashboard.html Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø²Ø§Ù„Ø© hamburger ÙˆØ¥Ø¶Ø§ÙØ© back button) */
    header {
      background: var(--primary-blue);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background-color 0.3s;
      box-shadow: 0 2px 8px var(--shadow-light);
    }

    header .logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    header h1 {
      font-size: 24px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
    }

    header small {
      font-size: 13px;
      color: #e3f2fd;
      margin-top: 2px;
    }

    /* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† hamburger) */
    #back-btn {
      font-size: 26px;
      background: var(--secondary-button-bg);
      border: none;
      color: var(--text-color);
      cursor: pointer;
      border-radius: 8px;
      padding: 6px 10px;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: inherit;
      font-weight: bold;
    }

    #back-btn:hover { 
      background: var(--secondary-button-hover);
    }

    /* Ø§Ù„ÙÙˆØªØ± (Ù…Ø¯Ù…Ø¬ Ù…Ù† dashboard.html) */
    footer {
  text-align: center;
  padding: 15px;
  background: var(--primary-blue);
  color: #fff;
  font-size: 14px;
  transition: background-color 0.3s;
  margin-top: auto;
  width: 100%; /* Ø¥Ø¶Ø§ÙØ© */
  box-sizing: border-box; /* Ø¥Ø¶Ø§ÙØ© */
}
.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px 15px;
  flex: 1;
  width: 100%; /* Ø¥Ø¶Ø§ÙØ© */
  box-sizing: border-box; /* Ø¥Ø¶Ø§ÙØ© */
}
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 6px 20px var(--shadow-light);
      padding: 20px;
      margin-bottom: 16px;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }

  
    /* Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ­Ø±Ùƒ (Ù…Ø­Ø³Ù† Ù…Ø¹ ØªØ£Ø«ÙŠØ± shimmer ÙƒÙ…Ø§ ÙÙŠ xray Ø§Ù„Ø³Ø§Ø¨Ù‚) */
    .animated-card {
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--animated-text-color);
      min-height: 40px;
      padding: 10px 20px;
      border-radius: 25px;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(96, 165, 250, 0.05));
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    [data-theme="dark"] .animated-card {
      background: linear-gradient(135deg, rgba(165, 180, 252, 0.1), rgba(165, 180, 252, 0.05));
    }

    .animated-card.show {
      opacity: 1;
      animation: fadeGlow 3s ease-in-out infinite;
    }

    .animated-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(96, 165, 250, 0.3), transparent);
      transform: rotate(45deg);
      animation: shimmer 3s linear infinite;
      opacity: 0;
    }

    .animated-card.show::before {
      opacity: 1;
    }

    @keyframes fadeGlow {
      0%, 100% { opacity: 0.6; transform: scale(1); text-shadow: 0 0 5px rgba(96, 165, 250, 0.3); }
      50% { opacity: 1; transform: scale(1.02); text-shadow: 0 0 20px rgba(96, 165, 250, 0.6); }
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%) rotate(45deg); }
      100% { transform: translateX(100%) rotate(45deg); }
    }

    .fade {
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }

    .fade.show {
      opacity: 1;
    }

    /* Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ÙŠÙ† (ÙƒÙ…Ø§ ÙÙŠ xray Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ù…Ø¹ card wrapper) */
    .info-cards {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .small-card {
      flex: 1;
      text-align: center;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-medium);
      padding: 12px;
      font-size: 14px;
      color: var(--secondary-text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .small-card h4 {
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--primary-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .small-card i {
      font-size: 1.2rem;
      color: var(--icon-color);
    }

    /* Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Ù…Ø­Ø³Ù† Ù…Ø¹ drag & drop) */
    .upload-area {
      border: 2px dashed var(--upload-border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      background: var(--upload-bg);
      color: var(--secondary-text);
      transition: background 0.3s ease, border-color 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .upload-area i {
      font-size: 3rem;
      color: var(--icon-color);
      transition: color 0.3s ease;
    }

    .upload-area:hover, .upload-area.dragover {
      background: var(--upload-hover-bg);
      border-color: var(--upload-hover-border);
    }

    .upload-area:hover i, .upload-area.dragover i {
      color: var(--upload-hover-border);
      transform: scale(1.1);
    }

    input[type=file] {
      display: none;
    }

    .file-name {
      text-align: center;
      margin-top: 10px;
      font-weight: 600;
      color: var(--text-color);
    }

    .preview-container {
      text-align: center;
      margin-top: 10px;
    }

    .preview-container img {
      max-width: 100%;
      max-height: 250px;
      border-radius: 10px;
    }

    /* Ø§Ù„Ø­Ù‚ÙˆÙ„ (ÙƒÙ…Ø§ ÙÙŠ xray Ø§Ù„Ø³Ø§Ø¨Ù‚) */
    input, select, textarea {
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      width: 100%;
      box-sizing: border-box;
      background: var(--card-bg);
      color: var(--text-color);
      transition: border-color 0.3s ease, background 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-blue);
      outline: none;
    }

    textarea {
      min-height: 72px;
      resize: vertical;
    }

    button {
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      background: var(--button-bg);
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    button:hover:not(:disabled), button:not(:disabled):hover {
      background: var(--button-hover);
      transform: translateY(-2px);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    button i {
      font-size: 1.1rem;
    }

    /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù…Ø¹ Ø¯Ø¹Ù… Ù„Ù„Ø«Ù‚Ø© ÙƒÙ…Ø§ ÙÙŠ xray) */
    #response {
      margin-top: 15px;
      display: none;
    }

    #response.show {
      display: block;
    }

    .result-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      box-shadow: 0 4px 10px var(--shadow-medium);
      transition: background 0.3s ease;
    }

    .result-card h3 {
      margin-top: 0;
      color: var(--primary-blue);
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .result-card h3 i {
      font-size: 1.3rem;
      color: var(--icon-color);
    }

    .result-card p strong i {
      font-size: 1rem;
      margin-left: 0.3rem;
      color: var(--icon-color);
    }

    .conf-high { color: var(--conf-high); font-weight: bold; }
    .conf-moderate { color: var(--conf-moderate); font-weight: bold; }
    .conf-low { color: var(--conf-low); font-weight: bold; }

    .action-buttons { justify-content: center;
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .action-btn {
      flex: 1;
      text-align: center;
    }

    .copy-btn {
      background: #2980b9;
    }

    .copy-btn:hover {
      background: #3498db;
    }

    .print-btn {
      background: #27ae60;
    }

    .print-btn:hover {
      background: #2ecc71;
    }

    /* Responsive Ù„Ù„Ù€RTL (Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ±) */
    @media (max-width: 768px) {
      header { padding: 10px 15px; }
      header h1 { font-size: 20px; }
      #back-btn { font-size: 18px; padding: 8px 12px; }
      .info-cards {
        flex-direction: column;
      }

      .container {
        padding: 10px 10px;
      }

      button {
        gap: 0.3rem;
      }

      .upload-area i {
        font-size: 2.5rem;
      }

      footer { padding: 10px; font-size: 12px; }
    }

    /* Dark Mode ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± (Ù…Ø¯Ù…Ø¬ Ù…Ù† dashboard) */
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background: var(--card-bg) !important;
      color: var(--text-color) !important;
      border-color: var(--border-color) !important;
    }

    [data-theme="dark"] input::placeholder,
    [data-theme="dark"] textarea::placeholder {
      color: var(--secondary-text) !important;
    }

    [data-theme="dark"] input::-webkit-input-placeholder,
    [data-theme="dark"] textarea::-webkit-input-placeholder {
      color: var(--secondary-text) !important;
    }

    [data-theme="dark"] input:-ms-input-placeholder,
    [data-theme="dark"] textarea:-ms-input-placeholder {
      color: var(--secondary-text) !important;
    }

    [data-theme="dark"] input[readonly],
    [data-theme="dark"] input[readonly="readonly"] {
      background: var(--card-bg) !important;
      color: var(--text-color) !important;
    }

    [data-theme="dark"] #back-btn {
      background: var(--secondary-button-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] #back-btn:hover {
      background: var(--secondary-button-hover);
    }
  </style>
</head>
<body data-theme="light"> <!-- Ø§ÙØªØ±Ø§Ø¶ÙŠ lightØŒ ÙŠØªØºÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù…Ø¯Ù…Ø¬ ÙˆÙ…Ø¹Ø¯Ù„ Ù…Ù† dashboard.html) -->
<header>
<div class="logo">
<h1><i class="fas fa-stethoscope"></i> Ø·Ø¨ÙŠØ¨ÙŠ</h1>
<small>Ø£ÙˆÙ„ ØªØ·Ø¨ÙŠÙ‚ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø·Ø¨ÙŠ ÙÙŠ Ø³ÙˆØ±ÙŠØ§</small>
</div>
<button id="back-btn">
<i class="fas fa-arrow-left"></i>
</button>
</header>
<div class="container">
<div class="wrap">
<div class="card">
<h1><i class="fas fa-x-ray"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø´Ø¹Ø§Ø¹ÙŠØ© Ùˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
<!-- Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ -->
<div class="card animated-card fade" id="animatedCard"></div>
</div>
<!-- Ù†Øµ Ù…ØªØ­Ø±Ùƒ (Ù…Ø­Ø³Ù† Ù…Ø¹ shimmer effect ÙƒÙ…Ø§ ÙÙŠ xray) -->
<!-- Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ÙŠÙ† (Ù…Ø«Ù„ xrayØŒ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯) -->
<div class="card">
<div class="info-cards">
<div class="small-card">
<h4><i class="fas fa-clock"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</h4>
<div id="dateTime"></div>
</div>
<div class="small-card">
<h4><i class="fas fa-file-medical"></i> Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
<div id="reportCount">0</div>
</div>
</div>
</div>
<!-- Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Ù…Ø¹ Ø¯Ø¹Ù… drag & drop) -->
<div class="card">
<div class="upload-area" id="uploadArea">
<i class="fas fa-cloud-upload-alt"></i>
<p>Ø§Ù†Ù‚Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡ Ù‡Ù†Ø§</p>
<input accept=".jpg,.jpeg,.png,.dcm" id="fileInput" type="file" multiple/>
</div>
<div class="file-name" id="fileName"></div>
<div class="preview-container" id="previewContainer"><img id="imagePreview" style="display:none;"/></div>
</div>
<!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ­Øµ (ÙƒÙ…Ø§ ÙÙŠ xray) -->
<div class="card">
<h3><i class="fas fa-stethoscope"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ­Øµ</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
<select id="examTypeSelect">
<option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ</option>
<option value="X-ray">X-ray</option>
<option value="MRI">MRI</option>
<option value="CT">CT</option>
<option value="ECG">ECG</option>
<option value="Laboratory">Laboratory Test</option>
</select>
<input id="ageInput" min="0" placeholder="Ø§Ù„Ø¹Ù…Ø±" type="number"/>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
<select id="genderSelect">
<option value="">Ø§Ù„Ø¬Ù†Ø³</option>
<option value="Male">Ø°ÙƒØ±</option>
<option value="Female">Ø£Ù†Ø«Ù‰</option>
</select>
<input id="reasonInput" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ÙØ­Øµ" type="text"/>
</div>
<textarea id="historyInput" placeholder="Ø£Ø¹Ø±Ø§Ø¶ Ø£Ùˆ ØªØ§Ø±ÙŠØ® Ù…Ø±Ø¶ÙŠ Ø¥Ø¶Ø§ÙÙŠ" style="margin-top:12px;"></textarea>
<div style="margin-top:12px;text-align:center;">
<button disabled="" id="analyzeBtn"><i class="fas fa-play-circle"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
</div>
</div>
<!-- Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
<div id="response">
<div class="result-card" id="card-meta"></div>
<div class="result-card" id="card-findings"></div>
<div class="result-card" id="card-differential"></div>
<div class="action-buttons">
<button class="action-btn copy-btn" id="copyBtn"><i class="fas fa-copy"></i> Ù†Ø³Ø®</button>
</div>
</div>
</div>
</div>
<!-- Ø§Ù„ÙÙˆØªØ± (Ù…Ø¯Ù…Ø¬ Ù…Ù† dashboard.html) -->
<footer>Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ Kasp-ai</footer>
<script>
    // --- Gemini API Integration ---
    const API_KEY = "AIzaSyCTpQOvoMLUb9mX1dos-zw0uLqKjs5ADTE";
    async function analyzeWithGemini(uploadedFile, prompt) {
      const reader = new FileReader();
      return new Promise((resolve, reject) => {
        reader.onload = async () => {
          try {
            const base64Image = reader.result.split(',')[1];
            const body = {
              contents: [{
                parts: [
                  { inline_data: { mime_type: uploadedFile.type, data: base64Image } },
                  { text: prompt }
                ]
              }]
            };

            const response = await fetch(
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=" + API_KEY,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
              }
            );

            const data = await response.json();
            if (data?.candidates?.length) {
              resolve(data.candidates[0].content.parts.map(p => p.text || "").join("\n"));
            } else {
              reject(new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±"));
            }
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(uploadedFile);
      });
    }


    // ÙƒÙˆØ¯ Ø§Ù„Ù€Dark Mode Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙƒÙ…Ø§ ÙÙŠ xray)
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(prefersDark ? 'dark' : 'light');

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      applyTheme(e.matches ? 'dark' : 'light');
    });

    // Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ (Ø¬Ø¯ÙŠØ¯: ÙŠØ¹ÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ dashboard.html)
    document.addEventListener('DOMContentLoaded', () => {
      const backBtn = document.getElementById('back-btn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          if (window.history.length > 1) {
            window.history.back(); // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ§Ø±ÙŠØ®ØŒ Ø§Ø±Ø¬Ø¹ Ù„Ù„Ø®Ù„Ù
          } else {
            window.location.href = 'dashboard.html'; // Ø¥Ù„Ø§ØŒ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ dashboard
          }
        });
      }
    });

    // Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„ØªØ£Ø«ÙŠØ±)
    const messages = [
      "<i class='fas fa-hospital' style='margin-left:0.5rem; color:var(--animated-text-color);'></i> Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙÙŠ Ù‚Ø³Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø´Ø¹Ø§Ø¹ÙŠØ© Ùˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ©",
      "<i class='fas fa-brain' style='margin-left:0.5rem; color:var(--animated-text-color);'></i> Ø§Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ±Ùƒ Ø£Ùˆ ØµÙˆØ±ØªÙƒ ÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„Ù‡Ø§"
    ];
    let msgIndex = 0;
    const animatedCard = document.getElementById("animatedCard");

    function showMessage() {
      animatedCard.classList.remove("show");
      setTimeout(() => {
        animatedCard.innerHTML = messages[msgIndex];
        animatedCard.classList.add("show");
        msgIndex = (msgIndex + 1) % messages.length;
      }, 500);
    }
    setInterval(showMessage, 4000);
    showMessage();

    // Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® (ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©)
    function updateDateTime() {
      const now = new Date();
      document.getElementById("dateTime").textContent = now.toLocaleString('ar-EG');
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Ø¹Ø¯Ø§Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± (ÙŠØ²ÙŠØ¯ Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù„ÙŠÙ„)
    let reportCount = 0;
    function incrementReportCount() {
      reportCount++;
      document.getElementById("reportCount").textContent = reportCount;
    }

    // Ø±ÙØ¹ ÙˆØ¶ØºØ· Ø§Ù„ØµÙˆØ± (Ù…Ø¹ drag & drop ÙˆØ¥ØµÙ„Ø§Ø­ innerHTML)
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const fileName = document.getElementById('fileName');
    const imagePreview = document.getElementById('imagePreview');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const previewContainer = document.getElementById('previewContainer');
    let uploadedFiles = [];

    // Ø¯Ø¹Ù… drag & drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) processFile(file);
    });

    

    
function processFiles(files) {
  for (const file of files) {
    if (!file.type.includes("image")) continue;
    uploadedFiles.push(file);

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.createElement("img");
      img.src = e.target.result;
      img.style.maxWidth = "150px";
      img.style.maxHeight = "150px";
      img.style.margin = "6px";
      img.style.borderRadius = "10px";
      previewContainer.appendChild(img);
    };
    reader.readAsDataURL(file);
  }

  if (uploadedFiles.length > 0) {
    const fileList = uploadedFiles.map(f => f.name).join("<br>");
    fileName.innerHTML = `
      <i class="fas fa-images" style="color:var(--icon-color); margin-left:0.5rem;"></i>
      <strong>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±:</strong> ${uploadedFiles.length}<br>
      <div style="font-size:13px; color:var(--secondary-text); margin-top:4px;">${fileList}</div>
    `;
  } else {
    fileName.textContent = "";
  }

  analyzeBtn.disabled = uploadedFiles.length === 0;
  fileInput.value = ""; // reset input
  uploadArea.blur();    // prevent reopening file dialog
  document.activeElement.blur(); // ensure blur on mobile
}

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  processFiles(e.dataTransfer.files);
});
uploadArea.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => processFiles(e.target.files));


    // Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ø¨Ø± puter.ai (Ù…Ø¹ streaming ÙˆØ¥ØµÙ„Ø§Ø­Ø§Øª)
    analyzeBtn.addEventListener('click', async () => {
  if (uploadedFiles.length === 0) {
    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„');
    return;
  }

  const reason = document.getElementById('reasonInput').value.trim();
  const examType = document.getElementById('examTypeSelect').value;
  const age = document.getElementById('ageInput').value.trim();
  const gender = document.getElementById('genderSelect').value;
  const history = document.getElementById('historyInput').value.trim();

  if (!examType || !reason || !age || !gender) {
    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
    return;
  }

  analyzeBtn.disabled = true;
  analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...';
  const responseEl = document.getElementById('response');
  responseEl.classList.add('show');

  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  document.getElementById('card-meta').innerHTML = `
    <h3><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h3>
    <p><strong><i class="fas fa-x-ray"></i> Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ:</strong> ${examType}</p>
    <p><strong><i class="fas fa-question-circle"></i> Ø§Ù„Ø³Ø¨Ø¨:</strong> ${reason}</p>
    <p><strong><i class="fas fa-birthday-cake"></i> Ø§Ù„Ø¹Ù…Ø±:</strong> ${age}</p>
    <p><strong><i class="fas fa-venus-mars"></i> Ø§Ù„Ø¬Ù†Ø³:</strong> ${gender}</p>
    <p><strong><i class="fas fa-history"></i> ØªØ§Ø±ÙŠØ® Ø¥Ø¶Ø§ÙÙŠ:</strong> ${history || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
  `;

  document.getElementById('card-findings').innerHTML = "<h3><i class='fas fa-eye'></i> Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</h3><p><i class='fas fa-spinner fa-spin'></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>";
  document.getElementById('card-differential').innerHTML = "<h3><i class='fas fa-stethoscope'></i> Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª Ø§Ù„ØªÙØ±ÙŠÙ‚ÙŠØ©</h3><p><i class='fas fa-spinner fa-spin'></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>";

  try {
    let allResults = "";
    for (const file of uploadedFiles) {
      const result = await analyzeWithGemini(file, prompt);
      allResults += `

ğŸ“¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: ${file.name}
${result}`;
    }
    const text = allResults;

    document.getElementById('card-findings').innerHTML =
      "<h3><i class='fas fa-eye'></i> Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</h3>" +
      extractSection(text, "Ù…Ø´Ø§Ù‡Ø¯Ø§Øª");
    document.getElementById('card-differential').innerHTML =
      "<h3><i class='fas fa-stethoscope'></i> Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª Ø§Ù„ØªÙØ±ÙŠÙ‚ÙŠØ©</h3>" +
      extractSection(text, "ØªØ´Ø®ÙŠØµØ§Øª ØªÙØ±ÙŠÙ‚ÙŠØ©");

    incrementReportCount();
  } catch (err) {
    document.getElementById('card-findings').innerHTML = `<h3><i class='fas fa-exclamation-triangle'></i> Ø®Ø·Ø£</h3><p><strong><i class='fas fa-times'></i> ${err.message}</strong></p>`;
    document.getElementById('card-differential').innerHTML = '';
  }

  analyzeBtn.innerHTML = '<i class="fas fa-play-circle"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„';
  analyzeBtn.disabled = false;
});

    function extractSection(text, section) {
      const regex = new RegExp(`${section}:[\\s\\S]*?(?=(Ù…Ø´Ø§Ù‡Ø¯Ø§Øª:|ØªØ´Ø®ÙŠØµØ§Øª ØªÙØ±ÙŠÙ‚ÙŠØ©:|Ù…Ù„Ø§Ø­Ø¸Ø§Øª:|$))`, "i");
      const match = text.match(regex);
      if (match) {
        return formatAsList(match[0].replace(`${section}:`, "").trim());
      }
      return `<p><i class='fas fa-exclamation-triangle' style='color:var(--primary-blue);'></i> Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${section}</p>`;
    }

    function formatAsList(text) {
      const lines = text.split(/\n|-/).map(l => l.trim()).filter(l => l);
      return "<ul style='text-align:right;'>" + lines.map(l => {
        // Ø¯Ø¹Ù… Ù„Ù„Ø«Ù‚Ø© (High/Moderate/Low)
        let confClass = '';
        if (l.includes('High')) confClass = 'conf-high';
        else if (l.includes('Moderate')) confClass = 'conf-moderate';
        else if (l.includes('Low')) confClass = 'conf-low';
        return `<li class="${confClass}"><i class='fas fa-check-circle' style='color:var(--icon-color); margin-left:0.5rem;'></i>${l}</li>`;
      }).join("") + "</ul>";
    }

    // Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø¥ØµÙ„Ø§Ø­ Ù„Ù„Ù€ HTMLØŒ Ø§Ø³ØªØ®Ø¯Ù… textContent Ù„Ù„Ù†Øµ Ø§Ù„Ù†Ù‚ÙŠ)
    document.getElementById('copyBtn').onclick = () => {
      const meta = document.getElementById("card-meta").textContent;
      const findings = document.getElementById("card-findings").textContent;
      const diff = document.getElementById("card-differential").textContent;
      const reportText = `${meta}\n\n${findings}\n\n${diff}`;
      navigator.clipboard.writeText(reportText).then(() => {
        alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­");
      }).catch(() => {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®");
      });
    };
  </script>
<script>
// Ø¯Ø§Ù„Ø© Ø§Ù„Ø«ÙŠÙ… (Ø§Ù†Ø³Ø®Ù‡Ø§ ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©)
function initTheme() {
  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme); // Ø£Ùˆ document.body
    localStorage.setItem('theme', theme); // Ø­ÙØ¸ Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø²Ø±ØŒ Ø­Ø¯Ø«Ù‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    const toggleBtn = document.getElementById('themeToggle'); // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø²Ø±
    if (toggleBtn) {
      const icon = toggleBtn.querySelector('i');
      const text = theme === 'dark' ? 'ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±' : 'ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„';
      icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      toggleBtn.innerHTML = `${icon.outerHTML} ${text}`;
    }
  }

  const savedTheme = localStorage.getItem('theme') || 'light';
  applyTheme(savedTheme);

  // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø²Ø± themeToggleØŒ Ø£Ø¶Ù event listener
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme);
    });
  }
}

// Ø´ØºÙ„Ù‡Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', initTheme);
</script>
</body>
</html>
