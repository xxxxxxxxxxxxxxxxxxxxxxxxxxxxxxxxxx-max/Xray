<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام تحليل الصور الطبي - Hyper-Med</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body {font-family: 'Cairo', sans-serif; background:#f4f7fb; margin:0; color:#333;}
    header {background:linear-gradient(135deg,#2b5f87,#3f88c5); color:white; padding:25px; text-align:center;}
    header h1{margin:0; font-size:26px; font-weight:700;}
    header p{margin:8px 0 0; font-size:15px; opacity:.9;}

    .container {max-width:1000px; margin:30px auto; padding:0 15px;}
    .card {background:white; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.08); padding:25px; margin-bottom:20px; transition:all .3s ease;}
    .card:hover{box-shadow:0 10px 30px rgba(0,0,0,.12);}

    .upload-area{border:2px dashed #b3cce6; border-radius:12px; padding:40px; text-align:center; cursor:pointer; background:#f9fcff; transition:all .2s ease;}
    .upload-area:hover{background:#eef6ff; border-color:#3f88c5;}
    .upload-area.dragover{background:#dcefff; border-color:#2b5f87;}
    input[type=file]{display:none;}

    .file-name{margin-top:15px; font-weight:bold; color:#444; text-align:center;}
    .preview-container{margin-top:20px; text-align:center;}
    .preview-container img{max-width:100%; max-height:280px; border-radius:12px; border:1px solid #eee;}
    .compression-info{margin-top:15px; text-align:center; background:#f8fafc; padding:10px; border-radius:8px; font-size:14px; color:#555;}

    input[type=text], select {padding:12px; font-size:15px; border-radius:8px; border:1px solid #bbb; width:100%; max-width:500px; margin-top:10px;}
    button{padding:14px 22px; border:none; border-radius:10px; color:white; font-weight:600; font-size:16px; cursor:pointer; transition:all .2s ease;}
    .btn-primary{background:#2b5f87;}
    .btn-primary:hover{background:#3f88c5;}

    #response{margin-top:25px; display:none;}
    #response.show{display:block;}

    .result-card {background:white; border-radius:12px; padding:20px; margin-bottom:15px; box-shadow:0 4px 12px rgba(0,0,0,.05);}
    .result-card h3{margin-top:0; color:#2b5f87; font-size:18px; margin-bottom:10px;}

    .print-btn {background:#27ae60; margin-top:15px;}
    .print-btn:hover{background:#2ecc71;}

    @media print {
      body {background:white;}
      header, .card, .upload-area, #reasonInput, #examTypeSelect, #analyzeBtn, .print-btn, .file-name, .preview-container, .compression-info {display:none !important;}
      #response {display:block !important; box-shadow:none; margin:0; padding:0;}
      #response .result-card {box-shadow:none; border:none; margin:0; padding:10px 0;}
      #response:before {content:"التحليل\a\a"; white-space:pre; font-size:20px; font-weight:bold;}
    }

    @media (max-width:600px){
      header h1{font-size:22px;}
      .card{padding:18px;}
      button{width:100%;}
    }
  </style>
</head>
<body>
  <header>
    <h1>نظام تحليل الصور الطبي</h1>
    <p>قم بتحميل الملفات الطبية، أدخل نوع الفحص وسبب الفحص، لتحصل على تقرير موجز ومنظم</p>
  </header>

  <div class="container">
    <div class="card">
      <div class="upload-area" id="uploadArea">
        <p>📂 انقر لتحميل الملف أو اسحبه هنا</p>
        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf,.dcm" />
      </div>
      <div class="file-name" id="fileName"></div>
      <div class="preview-container" id="previewContainer"><img id="imagePreview" /></div>
      <div class="compression-info" id="compressionInfo"></div>
    </div>

    <div class="card">
      <h3>✍️ أدخل تفاصيل الفحص:</h3>
      <select id="examTypeSelect">
        <option value="">اختر نوع الفحص</option>
        <option value="X-ray">X-ray</option>
        <option value="MRI">MRI</option>
        <option value="CT">CT</option>
        <option value="ECG">ECG</option>
        <option value="Laboratory test">Laboratory test</option>
      </select>
      <input type="text" id="reasonInput" placeholder="سبب الفحص (مثال: ضيق نفس حاد)">
      <div style="margin-top:20px;">
        <button id="analyzeBtn" class="btn-primary" disabled>🚀 بدء التحليل</button>
      </div>
    </div>

    <div id="response">
      <div class="result-card" id="card-meta"></div>
      <div class="result-card" id="card-findings"></div>
      <div class="result-card" id="card-differential"></div>
      <button class="print-btn" onclick="window.print()">🖨️ طباعة / تصدير PDF</button>
    </div>
  </div>

  <script>
    const fileInput=document.getElementById('fileInput');
    const uploadArea=document.getElementById('uploadArea');
    const fileName=document.getElementById('fileName');
    const previewContainer=document.getElementById('previewContainer');
    const imagePreview=document.getElementById('imagePreview');
    const compressionInfo=document.getElementById('compressionInfo');
    const analyzeBtn=document.getElementById('analyzeBtn');
    const response=document.getElementById('response');
    const cardMeta=document.getElementById('card-meta');
    const cardFindings=document.getElementById('card-findings');
    const cardDifferential=document.getElementById('card-differential');
    const reasonInput=document.getElementById('reasonInput');
    const examTypeSelect=document.getElementById('examTypeSelect');

    let uploadedFile=null, compressedFile=null, originalSize=0, compressedSize=0;

    uploadArea.addEventListener('click',()=>fileInput.click());
    uploadArea.addEventListener('dragover',e=>{e.preventDefault();uploadArea.classList.add('dragover');});
    uploadArea.addEventListener('dragleave',()=>uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop',e=>{e.preventDefault();uploadArea.classList.remove('dragover');processFile(e.dataTransfer.files[0]);});
    fileInput.addEventListener('change',e=>processFile(e.target.files[0]));

    function processFile(file){
      if(!file)return;
      uploadedFile=file; originalSize=file.size;
      fileName.textContent=`📄 تم اختيار: ${file.name} (${formatFileSize(file.size)})`;
      fileName.style.display='block';
      if(file.type.includes('image')){
        const reader=new FileReader();
        reader.onload=e=>{
          const img=new Image();
          img.onload=()=>{
            const canvas=document.createElement('canvas');
            const ctx=canvas.getContext('2d');
            canvas.width=img.width; canvas.height=img.height;
            ctx.drawImage(img,0,0);
            canvas.toBlob(blob=>{
              compressedFile=new File([blob],file.name,{type:'image/jpeg'});
              compressedSize=blob.size;
              imagePreview.src=URL.createObjectURL(blob);
              previewContainer.style.display='block';
              compressionInfo.innerHTML=`الحجم الأصلي: ${formatFileSize(originalSize)} | بعد الضغط: ${formatFileSize(compressedSize)}`;
              compressionInfo.style.display='block';
            },'image/jpeg',0.9);
          };
          img.src=e.target.result;
        };
        reader.readAsDataURL(file);
      }
      analyzeBtn.disabled=false;
    }

    analyzeBtn.addEventListener('click',analyzeImage);

    async function analyzeImage(){
      if(!uploadedFile)return;
      const reason=reasonInput.value.trim();
      const examType=examTypeSelect.value;
      if(!examType || !reason){alert('⚠️ يرجى اختيار نوع الفحص وكتابة سببه'); return;}

      analyzeBtn.disabled=true;
      response.classList.add('show');

      cardMeta.innerHTML=`<h3>📌 معلومات أساسية</h3>
        <p><strong>🕒 تاريخ التحليل:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
        <p><strong>🖼️ نوع الفحص:</strong> ${examType}</p>
        <p><strong>📄 سبب الفحص:</strong> ${reason}</p>`;
      cardFindings.innerHTML=`<h3>👀 المشاهدات</h3><p>⏳ جاري التحليل...</p>`;
      cardDifferential.innerHTML=`<h3>⚕️ التشخيصات التفريقية</h3><p>⏳ جاري التحليل...</p>`;

      try{
        const fileToUpload=compressedFile||uploadedFile;
        const fileExtension=fileToUpload.name.split('.').pop();
        const puterFile=await puter.fs.write(`medical_${Date.now()}.${fileExtension}`,fileToUpload);
        const uploadedPath=puterFile.path;

        const prompt=`أنت خبير طبي مساعد. المطلوب:\n\n- الملف المرفق هو نتيجة فحص طبي.\n- نوع الفحص: ${examType}.\n- سبب طلب الفحص: ${reason}.\n\nأعطني النتيجة فقط بهذا الشكل:\n\nمشاهدات:\n- نقطة 1\n- نقطة 2\n- نقطة 3\n\nتشخيصات تفريقية:\n- احتمال 1\n- احتمال 2\n- احتمال 3`;

        const completion=await puter.ai.chat([
          {role:'user',content:[{type:'file',puter_path:uploadedPath},{type:'text',text:prompt}]}
        ],{model:'gpt-5',stream:true});

        let text='';
        for await(const part of completion){
          if(part?.text){
            text+=part.text;
            cardFindings.innerHTML=`<h3>👀 المشاهدات</h3>${extractSection(text,'مشاهدات')}`;
            cardDifferential.innerHTML=`<h3>⚕️ التشخيصات التفريقية</h3>${extractSection(text,'تشخيصات تفريقية')}`;
          }
        }
        await puter.fs.delete(uploadedPath);
      }catch(err){
        cardFindings.innerHTML='<strong>⚠️ خطأ:</strong> '+err.message;
      }
      analyzeBtn.disabled=false;
    }

    function extractSection(text,section){
      const regex=new RegExp(section+":([\\s\\S]*?)(?=(مشاهدات:|تشخيصات تفريقية:|$))","i");
      const match=text.match(regex);
      if(match){return formatAsList(match[1].trim());}
      return '<p>⚠️ لم يتم العثور على '+section+'</p>';
    }

    function formatAsList(text){
      const lines=text.split(/\n|-/).map(l=>l.trim()).filter(l=>l);
      return '<ul>'+lines.map(l=>`<li>${l}</li>`).join('')+'</ul>';
    }

    function formatFileSize(bytes){
      if(bytes<1024)return bytes+' بايت';
      else if(bytes<1048576)return(bytes/1024).toFixed(2)+' كيلوبايت';
      else return(bytes/1048576).toFixed(2)+' ميجابايت';
    }
  </script>
</body>
</html>
